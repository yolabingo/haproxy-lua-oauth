global
    daemon
    lua-load /usr/local/share/lua/5.3/jwtverify.lua

    # Set env variables used by Lua file...

    # If using RS256 signature: Path to public key certificate tokens are signed with (get from your token issuer, like auth0.com):
    setenv OAUTH_PUBKEY_PATH /etc/haproxy/pem/pubkey.pem

defaults
    timeout connect 5s
    timeout client  5s
    timeout server  5s
    mode http
 
frontend api_gateway
    # Good practice to secure communication when passing tokens
    # bind :443 ssl crt /etc/haproxy/pem/test.com.pem alpn h2,http1.1
    bind :80

    # Deny if no Authorization header sent
    http-request deny unless { req.hdr(authorization) -m found }

    # Invoke the jwtverify Lua file
    http-request lua.jwtverify

    # Deny unless jwtverify set 'authorized' to true
    http-request deny unless { var(txn.authorized) -m bool }

    default_backend apiservers

backend apiservers
    balance roundrobin
    server server1 127.0.0.1:8080

